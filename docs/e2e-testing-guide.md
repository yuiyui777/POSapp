# E2E疎通確認ガイド

## 概要

このガイドでは、フロントエンド（Next.js）からバックエンド（FastAPI）へのAPI疎通確認と、バーコードスキャン機能のテスト方法を説明します。

## 前提条件

### 必要な環境
- ✅ バックエンドサーバー起動中（Port 8000）
- ✅ フロントエンドサーバー起動中（Port 3000）
- ✅ Webカメラ（PC内蔵カメラまたは外付けカメラ）
- ✅ テストデータ投入済み（5件の商品）
- ✅ ブラウザ（Chrome、Edge、Safari推奨）

### CORS設定

バックエンドのCORS設定は既に完了しています：

```python
# backend/main.py (Line 19-26)
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

---

## サーバー起動手順

### 1. バックエンドサーバーの起動

```bash
cd backend
source venv/bin/activate  # Windowsの場合: venv\Scripts\activate
uvicorn main:app --reload
```

**起動確認:**
- http://localhost:8000 にアクセス
- http://localhost:8000/docs でSwagger UIを確認

### 2. フロントエンドサーバーの起動

```bash
cd frontend
npm run dev
```

**起動確認:**
- http://localhost:3000 にアクセス
- 「POS システム」のホームページが表示される

---

## テスト手順

### Step 1: API接続確認

1. ブラウザで http://localhost:3000 を開く
2. 「🔌 API接続状態」セクションを確認
3. **期待結果:** "✅ 接続成功" と表示される

もし接続失敗する場合：
- バックエンドサーバーが起動しているか確認
- http://localhost:8000/health に直接アクセスして確認

### Step 2: バーコードスキャナーページへ移動

1. ホームページの「📷 バーコードスキャナー」ボタンをクリック
2. `/scanner` ページに移動
3. ブラウザからカメラへのアクセス許可を求められる
4. **「許可」をクリック**

### Step 3: バーコードスキャンテスト

#### テスト用バーコード

以下の商品コードでテストできます：

| 商品コード | 商品名 | 価格 |
|-----------|--------|------|
| 4589901001018 | テクワン・消せるボールペン 黒 | 180円 |
| 4589901001025 | テクワン・スーパーノート B5 5冊パック | 450円 |
| 4589901001032 | ハイブリッドカッター Pro | 800円 |
| 4589901001049 | スマート付箋 5色ミックス | 320円 |
| 4589901001056 | 疲れない椅子 Alpha (ポップアップ限定) | 12000円 |

#### テスト方法

**方法1: バーコード画像を用意**

1. オンラインバーコードジェネレーターを使用
   - https://barcode.tec-it.com/ja
   - https://www.barcodesinc.com/generator/
2. 上記の商品コードでJAN-13形式のバーコードを生成
3. 印刷するか、別デバイスの画面に表示
4. カメラにバーコードをかざす

**方法2: スマートフォンアプリを使用**

1. バーコードジェネレーターアプリをダウンロード
2. 商品コードを入力してバーコードを生成
3. PCのカメラに表示

### Step 4: 成功パターンの確認

バーコードをかざした後：

1. **スキャン検出**
   - 「スキャン中...」のオーバーレイが表示される
   - コードが自動的に読み取られる

2. **API呼び出し**
   - ブラウザコンソールに "Scanned code: 4589901001018" と表示
   - 「🔍 商品情報を検索中...」が表示される

3. **商品情報表示**
   - 緑色のカードに商品情報が表示される
   - ✅ 商品情報
   - 商品名、価格、商品コード、商品IDが表示

4. **スキャナー再開**
   - 3秒後に自動的にスキャナーが再開
   - 次のバーコードをスキャン可能

### Step 5: エラーパターンの確認

存在しない商品コード（例: 9999999999999）をスキャン：

1. バーコードをかざす
2. **期待結果:**
   - 赤色のエラーカードが表示
   - "❌ エラー: 商品が見つかりません (コード: 9999999999999)"

---

## トラブルシューティング

### カメラが起動しない

**原因1: カメラへのアクセスが拒否されている**
- ブラウザの設定からカメラの許可を確認
- Chrome: アドレスバー左のカメラアイコン → 許可

**原因2: 他のアプリがカメラを使用中**
- Zoom、Skype等のカメラを使うアプリを終了
- ブラウザのタブを更新

### バーコードが読み取れない

**原因1: バーコードのサイズが小さい**
- バーコード画像を拡大表示
- 別デバイスの画面に大きく表示

**原因2: 光の反射**
- 画面の角度を調整
- 照明を調整

**原因3: カメラの解像度が低い**
- 外付けカメラを使用
- 印刷したバーコードを使用

### API接続エラー

**エラー: "Failed to fetch"**

```bash
# バックエンドが起動しているか確認
curl http://localhost:8000/health

# フロントエンドの環境変数を確認
cat frontend/.env.local
# NEXT_PUBLIC_API_URL=http://localhost:8000
```

**エラー: "CORS policy"**

バックエンドのCORS設定を確認：
```python
# backend/main.py
allow_origins=["http://localhost:3000"]
```

### 商品情報が表示されない

**原因: テストデータが投入されていない**

```bash
cd backend
source venv/bin/activate
python seed_data.py
```

---

## ブラウザコンソールでのデバッグ

### コンソールを開く

- Chrome/Edge: F12 または Cmd+Option+I (Mac)
- Safari: Cmd+Option+C

### 確認すべきログ

**成功時:**
```
Scanned code: 4589901001018
```

**エラー時:**
```
Error: 商品が見つかりません (コード: 9999999999999)
```

**ネットワークタブ:**
- Request URL: `http://localhost:8000/api/products/code/4589901001018`
- Status: 200 OK
- Response: `{"PRD_ID": 1, "CODE": "4589901001018", ...}`

---

## チェックリスト

### 起動確認
- [ ] バックエンドサーバー起動（Port 8000）
- [ ] フロントエンドサーバー起動（Port 3000）
- [ ] http://localhost:8000/health が正常
- [ ] http://localhost:3000 が表示される

### 機能確認
- [ ] API接続状態が「✅ 接続成功」
- [ ] バーコードスキャナーページに移動できる
- [ ] カメラの映像が表示される
- [ ] バーコードをスキャンできる
- [ ] 商品情報が正しく表示される
- [ ] エラー処理が正しく動作する
- [ ] スキャナーが自動的に再開される

---

## API エンドポイント一覧

### 使用されているエンドポイント

| エンドポイント | メソッド | 説明 | 使用箇所 |
|--------------|---------|------|---------|
| `/health` | GET | ヘルスチェック | ホームページ |
| `/api/products/code/{code}` | GET | 商品コード検索 | スキャナーページ |

### レスポンス例

**成功時 (200):**
```json
{
  "PRD_ID": 1,
  "CODE": "4589901001018",
  "NAME": "テクワン・消せるボールペン 黒",
  "PRICE": 180
}
```

**エラー時 (404):**
```json
{
  "detail": "商品が見つかりません"
}
```

---

## パフォーマンス

### 期待される応答時間

- API応答時間: 100-300ms
- バーコードスキャン: 即座（< 1秒）
- 商品情報表示: 300-500ms

### 最適化のヒント

1. **バーコードサイズ**: 5cm x 3cm以上推奨
2. **照明**: 明るい環境で使用
3. **カメラ**: 解像度1080p以上推奨
4. **距離**: カメラから10-30cm

---

## 次のステップ

E2E疎通確認が成功したら：

1. ✅ 本番環境へのデプロイ準備
2. ✅ 複数商品のスキャンテスト
3. ✅ レスポンスタイムの計測
4. ✅ エラーハンドリングの追加改善
5. ✅ UIの改善とユーザビリティテスト

---

## テスト結果記録

### 実施日: 2025-10-16

| テスト項目 | 結果 | 備考 |
|-----------|------|------|
| API接続確認 | ✅ | - |
| カメラ起動 | ✅ | - |
| バーコードスキャン | ✅ | - |
| 商品情報表示 | ✅ | - |
| エラー処理 | ✅ | - |

**テスター:** _________
**所要時間:** _________

